#!/bin/bash
set -euo pipefail

{{ range $host, $containers := groupByMulti $ "Env.VIRTUAL_HOST" "," }}
{{/* Set the cert name to <domain.tld>, stripping any subdomain for use of wildcard cert */}}
{{ $host := trim $host }}
{{ $hostParts := split $host "." }}
{{ $tld := last $hostParts }}
{{ $hostNoTLDParts := split (trimSuffix (printf ".%s" $tld) $host) "." }}
{{ $cert := printf "%s.%s" (last $hostNoTLDParts) $tld }}


echo "Generating wildcard cert for {{ $cert }}"
mkcert -cert-file /etc/nginx/certs/{{ $cert }}.crt -key-file /etc/nginx/certs/{{ $cert }}.key "*.{{ $cert }}"

{{ end }}
