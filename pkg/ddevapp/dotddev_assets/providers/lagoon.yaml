#ddev-generated
# Lagoon provider configuration.

# To use this configuration,

# 1. Check out the project and then configure it with 'ddev config'. You'll want to use 'ddev start' and make sure the basic functionality is working.
# 2. Add LAGOON_PROJECT and LAGOON_ENVIRONMENT variables to your project in 'web_environment' or a '.ddev/.env'
#    ```yaml
#    web_environment:
#        - LAGOON_PROJECT=<project-name>
#        - LAGOON_ENVIRONMENT=<environment-name>
#    ```
#    You can also do this with `ddev config --web-environment-add="LAGOON_PROJECT=<project-name>,LAGOON_ENVIRONMENT=<environment-name>"`.
# 3. Syncing is done via lagoon-sync which must be configured in your .lagoon.yml or .lagoon-sync.yml,
#    see the DDEV example .lagoon.yml at https://github.com/ddev/test-amazeeio-lagoon/blob/main/.lagoon.yml#L27-L37
# 4. Configure an SSH key for your Lagoon user https://docs.lagoon.sh/using-lagoon-advanced/ssh/
# 5. `ddev auth ssh`.
# 6. `ddev restart`
# 7. `ddev pull lagoon`. After you agree to the prompt, the current upstream databases and files will be downloaded.
# 8. Optionally `ddev push lagoon` to push local files and database to Lagoon. This must be done with great care
#    if you're pushing to a production environment, but is great for pushing to branch environments.

auth_command:
  command: |
    set -eu -o pipefail
    ssh-add -l >/dev/null || ( echo "Please 'ddev auth ssh' before running this command." && exit 1 )
    if [ -z "${LAGOON_PROJECT:-}" ]; then echo "Please make sure you have set the LAGOON_PROJECT environment variable in your 'web_environment' or .ddev/.env." && exit 1; fi
    if [ -z "${LAGOON_ENVIRONMENT}" ]; then echo "Please make sure you have set the LAGOON_ENVIRONMENT environment variable in your 'web_environment' or .ddev/.env." && exit 1; fi
    # Defensive fix for missing known_hosts, see odd output in
    # https://github.com/uselagoon/lagoon-sync/issues/135
    # https://github.com/uselagoon/lagoon-cli/pull/488
    mkdir -p ~/.ssh && touch ~/.ssh/known_hosts && chmod -R go-rw ~/.ssh

db_import_command:
  command: |
    # set -x   # You can enable bash debugging output by uncommenting
    set -eu -o pipefail
    export MARIADB_HOST=db MARIADB_USERNAME=db MARIADB_PASSWORD=db MARIADB_DATABASE=db
    lagoon-sync sync mariadb -p ${LAGOON_PROJECT} -e ${LAGOON_ENVIRONMENT} --no-interaction

files_import_command:
  command: |
    #set -x   # You can enable bash debugging output by uncommenting
    set -eu -o pipefail
    lagoon-sync sync files -p ${LAGOON_PROJECT} -e ${LAGOON_ENVIRONMENT} --no-interaction

# push is very useful for non-production environments, but can be
# very dangerous to production environments. If it is dangerous to your
# workflow you can remove the lines below and remove the `ddev-generated` in this file
db_push_command:
  command: |
    set -eu -o pipefail
    #set -x   # You can enable bash debugging output by uncommenting
    export MARIADB_HOST=db MARIADB_USERNAME=db MARIADB_PASSWORD=db MARIADB_DATABASE=db
    lagoon-sync sync mariadb -p ${LAGOON_PROJECT} -t ${LAGOON_ENVIRONMENT} -e local --no-interaction

# push is very useful for non-production environments, but can be
# very dangerous to production environments. If it is dangerous to your
# workflow you can remove the lines below and remove the `ddev-generated` in this file
files_push_command:
  command: |
    set -eu -o pipefail
    #set -x   # You can enable bash debugging output by uncommenting
    lagoon-sync sync files -p ${LAGOON_PROJECT} -e local -t ${LAGOON_ENVIRONMENT} --no-interaction
