#!/bin/bash

## #ddev-generated: If you want to edit and own this file, remove this line.
## Description: Launch a browser with the current site
## Usage: launch [path] [-m|--mailpit]
## Example: "ddev launch" or "ddev launch /admin/reports/status/php" or "ddev launch phpinfo.php", for Mailpit "ddev launch -m"
## Flags: [{"Name":"url","Shorthand":"u","Usage":"ddev launch -u https://ddev.com"}, {"Name":"http_port","Shorthand":"p","Usage":"ddev launch -p 3000"}, {"Name":"https_port","Shorthand":"s","Usage":"ddev launch -s 3000"}, {"Name":"mailpit","Shorthand":"m","Usage":"ddev launch -m launches the mailpit UI"}]

while [ $# -gt 0 ]; do
  case "$1" in
  -m | --mailpit)
    ddev mailpit && exit 0
    ;;
  -p | --http_port)
    # Set the default HTTP port.
    HTTP_PORT="$2"
    shift
    ;;
  -s | --https_port)
    # Set the default HTTPS port.
    HTTPS_PORT="$2"
    shift
    ;;
  -u | --url)
    # Set the full target URL
    FULLURL="$2"
    shift
    ;;
  --) shift ;;
  esac
  shift
done

# Generate the full URL for the browser. This will include port.
generate_fullurl() {
  FULLURL=${DDEV_PRIMARY_URL}
  HTTPS=""
  if [ ${DDEV_PRIMARY_URL%://*} = "https" ]; then HTTPS=true; fi

  if [[ ! -z "${GITPOD_INSTANCE_ID}" ]] || [[ "${CODESPACES}" == "true" ]]; then
    FULLURL="${FULLURL/-${DDEV_HOST_WEBSERVER_PORT}/-${HTTP_PORT}}"
  else
    if [ "${HTTPS}" = "" ]; then
      FULLURL="${FULLURL%:[0-9]*}:${HTTP_PORT}"
    else
      FULLURL="${FULLURL%:[0-9]*}:${HTTPS_PORT}"
    fi
  fi
}

# If $FULLURL was not passsed, we will generate it based off $DDEV_PRIMARY_URL.
if [ -z "$FULLURL" ]; then
  generate_fullurl
fi

if [ -n "${1:-}" ] ; then
  if [[ ${1::1} != "/" ]] ; then
    FULLURL="${FULLURL}/";
  fi

  FULLURL="${FULLURL}${1}";
fi

# Print debug information and exit early.
if [ "${DDEV_DEBUG:-}" = "true" ]; then
  printf "FULLURL $FULLURL\n" && exit 0
fi

# Launch a browser based on the detected OS
case $OSTYPE in
  linux-gnu)
    if [[ ! -z "${GITPOD_INSTANCE_ID}" ]]; then
        gp preview ${FULLURL}
    else
        xdg-open ${FULLURL}
    fi
    ;;
  "darwin"*)
    open ${FULLURL}
    ;;
  "win*"* | "msys"*)
    start ${FULLURL}
    ;;
esac
