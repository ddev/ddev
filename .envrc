#!/usr/bin/env bash
# Direnv bootstrap for docs + dev tooling
# 1) Install direnv and hook into your shell. 2) (Optional) whitelist this file in ~/.config/direnv/direnv.toml
# When you cd into this dir, a local Python venv and Node env (via nodeenv) are ensured in .gotmp/env, and CLI tools added to PATH.

set -euo pipefail

PYTHON_ENV=".gotmp/env/python"
NODE_ENV=".gotmp/env/node"

# Quieter/faster package managers
export PIP_DISABLE_PIP_VERSION_CHECK=1
export PIP_ROOT_USER_ACTION=ignore
export npm_config_update_notifier=false
export npm_config_fund=false
export NPM_CONFIG_PREFIX="${NODE_ENV}"

mkdir -p .gotmp/env .gotmp/bin

# Pre-reqs
if ! command -v python >/dev/null 2>&1 && ! command -v python3 >/dev/null 2>&1; then
  echo "Python is not available." >&2; exit 1
fi
if ! command -v go >/dev/null 2>&1; then
  echo "Go is not available." >&2; exit 1
fi

# --- Python venv ---
if [[ ! -f "${PYTHON_ENV}/bin/activate" ]]; then
  echo "Initializing python venv..."
  (command -v python >/dev/null 2>&1 && python -m venv "${PYTHON_ENV}") || python3 -m venv "${PYTHON_ENV}"
fi
# shellcheck disable=SC1090
source "${PYTHON_ENV}/bin/activate"

# Ensure nodeenv is available inside the venv (only install if missing)
if ! command -v nodeenv >/dev/null 2>&1; then
  python -m pip install -q nodeenv
fi

# --- Node env (managed by nodeenv) ---
# If node binary is missing (or env is corrupt), recreate it once
if [[ ! -x "${NODE_ENV}/bin/node" ]]; then
  echo "Creating nodeenv (LTS)..."
  rm -rf "${NODE_ENV}"
  nodeenv --node=lts --prebuilt "${NODE_ENV}"
fi
# Activate by PATH only (faster than sourcing an activate script)
export PATH="${NODE_ENV}/bin:${PATH}"

# --- Python tooling ---
if [[ ! -x "${PYTHON_ENV}/bin/mkdocs" ]]; then
  echo "Installing mkdocs..."
  python -m pip install -q -r docs/mkdocs-pip-requirements
fi

# --- Node CLI tooling (install once if missing) ---
if [[ ! -x "${NODE_ENV}/bin/markdownlint" ]]; then
  echo "Installing markdownlint..."
  npm install -g --silent markdownlint-cli
fi

if [[ ! -x "${NODE_ENV}/bin/linkspector" ]]; then
  echo "Installing linkspector..."
  npm install -g --silent @umbrelladocs/linkspector
fi

if [[ ! -x "${NODE_ENV}/bin/textlint" ]]; then
  echo "Installing textlint..."
  npm install -g --silent textlint \
    textlint-filter-rule-comments \
    textlint-rule-no-todo \
    textlint-rule-stop-words \
    textlint-rule-terminology
fi

# Prepend ddev build bin to PATH
BIN_DIR="$PWD/.gotmp/bin/$(go env GOHOSTOS)_$(go env GOHOSTARCH)"
export PATH="$BIN_DIR:$PATH"
