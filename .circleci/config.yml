version: 2
jobs:
  # 'build' is the default build, the only one triggered automatically by github or anything else.
  build:
    machine: true
    working_directory: ~/go/src/github.com/drud/ddev
    environment:
      DRUD_DEBUG: "true"
      GOPATH: /home/circleci/go
    steps:
      - run: mkdir -p ~/go/{lib,pkg,src/github.com/drud/ddev}

      - checkout

      - run:
          command: ./.circleci/circle_vm_setup.sh
          name: NORMAL Circle VM setup - tools, docker, golang

      - run:
          command: echo "go version:$(go version) docker version=$(docker --version) docker-compose version=$(docker-compose --version) HOME=$HOME USER=$(whoami) PWD=$PWD"
          name: Installed tool versions

      # Now build using the regular ddev-only technique - this results in a fully clean set of executables.
      - run:
          command: make clean linux darwin windows
          name: Build the ddev executables

      # Run the built-in ddev tests with the executables just built.
      - run:
          command: make -s test
          name: ddev tests
          no_output_timeout: "20m"

      - run: make -s staticrequired

      - run:
          command: bin/linux/ddev version
          name: ddev version information

      # Now we store the artifacts, which are the ones built by the *normal* build (not the nightly, in case of nightly)
      - store_artifacts:
          path: bin/darwin/darwin_amd64/ddev
          destination: darwin/ddev
          name: Upload ddev (darwin)
      - store_artifacts:
          path: bin/linux/ddev
          destination: linux/ddev
          name: Upload ddev (linux)
      - store_artifacts:
          path: bin/windows/windows_amd64/ddev.exe
          destination: windows/ddev.exe
          name: Upload ddev (windows)

  # nightly is triggered only with nightly_build_trigger.sh
  nightly_build:
    machine: true
    working_directory: ~/go/src/github.com/drud/ddev
    environment:
      DRUD_DEBUG: "true"
      GOPATH: /home/circleci/go
    steps:
#      - run: mkdir -p ~/go/{lib,pkg,src/github.com/drud/ddev}

      - checkout

      - run:
          command: ./.circleci/circle_vm_setup.sh
          name: NIGHTLY BUILD Circle VM setup - tools, docker, golang

      - run:
          command: echo "go version:$(go version) docker version=$(docker --version) docker-compose version=$(docker-compose --version) HOME=$HOME USER=$(whoami) PWD=$PWD"
          name: Installed tool versions

      # The nightly build builds a ddev that can't be run elsewhere because the containers built in are not pushed.
      # Therefore we build this full nightly first, and then throw it away.
      - run:
          command: |
            make clean
            export VERSION=nightly.$(date +%Y%m%d%H%M%S)
            export VERSION="$(git describe --tags --always --dirty)-nightly.$(date +%Y%m%d%H%M%S)"
            echo VERSION=$VERSION
            git submodule update --init && git submodule update --remote
            make -f nightly_build.mak clean
            make -f nightly_build.mak -s --print-directory VERSION=$VERSION DdevVersion=$VERSION DBTag=$VERSION DBATag=$VERSION WebTag=$VERSION RouterTag=$VERSION  NGINX_LOCAL_UPSTREAM_FPM7_REPO_TAG=$VERSION NGINX_LOCAL_UPSTREAM_FPM7_REPO_TAG=$VERSION UPSTREAM_PHP_REPO_TAG=$VERSION
          no_output_timeout: "20m"
          name: Run full nightly build

      - run:
          command: bin/linux/ddev version
          name:  nightly-build ddev version information

      # Run the built-in ddev tests with the executables just built.
      - run:
          command: make test
          name: ddev tests
          no_output_timeout: "20m"

      - run: make -s staticrequired

      # Now build using the regular ddev-only technique - this results in a fully clean set of executables.
      - run:
          command: make clean linux darwin windows
          name: Build the ddev executables

      # Run the built-in ddev tests with the clean binaries just built.
      - run:
          command: make test
          name: ddev tests
          no_output_timeout: "20m"

      - run:
          command: bin/linux/ddev version
          name: ddev version information (clean binaries, not nightlies)

      # Now we store the artifacts, which are the ones built by the *normal* build (not the nightly, in case of nightly)
      - store_artifacts:
          path: bin/darwin/darwin_amd64/ddev
          destination: darwin/ddev
          name: Upload ddev (darwin)
      - store_artifacts:
          path: bin/linux/ddev
          destination: linux/ddev
          name: Upload ddev (linux)
      - store_artifacts:
          path: bin/windows/windows_amd64/ddev.exe
          destination: windows/ddev.exe
          name: Upload ddev (windows)

  # 'tag_build' is used to build a tag for release.
  tag_build:
    machine: true
    working_directory: ~/go/src/github.com/drud/ddev
    environment:
      DRUD_DEBUG: "true"
      GOPATH: /home/circleci/go
    steps:
      - run: mkdir -p ~/go/{lib,pkg,src/github.com/drud/ddev}

      - checkout

      - run:
          command: ./.circleci/circle_vm_setup.sh
          name: TAG BUILD Circle VM setup - tools, docker, golang

      # Now build using the regular ddev-only technique - this results in a fully clean set of executables.
      - run:
          command: make -s clean linux darwin windows
          name: Build the ddev executables

      - run:
          command: bin/linux/ddev version
          name: ddev version information

      - run:
          command: |
            mkdir /tmp/bin/{linux, darwin, windows} &&
            cp bin/darwin/darwin_amd64/ddev /tmp/bin/darwin/ &&
            cp bin/linux/ddev /tmp/bin/linux/ &&
            cp bin/windows/windows_amd64/ddev.exe /tmp/bin/windows

      - store_artifacts:
        path: /tmp/bin
        destination: all
        name: "Upload all artifacts together"



      # Now we store the artifacts, which are the ones built by the *normal* build (not the nightly, in case of nightly)
      - store_artifacts:
          path: bin/darwin/darwin_amd64/ddev
          destination: darwin/ddev
          name: Upload ddev (darwin)
      - store_artifacts:
          path: bin/linux/ddev
          destination: linux/ddev
          name: Upload ddev (linux)
      - store_artifacts:
          path: bin/windows/windows_amd64/ddev.exe
          destination: windows/ddev.exe
          name: Upload ddev (windows)


  # experimental test_build is used to build a tag for release.
  test_build:
    machine: true
    working_directory: ~/go/src/github.com/drud/ddev
    environment:
      DRUD_DEBUG: "true"
      GOPATH: /home/circleci/go
      ARTIFACTS: /artifacts
    steps:
      - run: mkdir -p ~/go/{lib,pkg,src/github.com/drud/ddev}

      - checkout

      - run:
          command: ./.circleci/circle_vm_setup.sh
          name: TEST BUILD Circle VM setup - tools, docker, golang

      # Now build using the regular ddev-only technique - this results in a fully clean set of executables.
      - run:
          command: make clean linux darwin windows
          name: Build the ddev executables

      - run:
          command: bin/linux/ddev version
          name: ddev version information

      - run:
          command: |
            mkdir -p /tmp/bin/{linux,darwin,windows} &&
            cp bin/darwin/darwin_amd64/ddev /tmp/bin/darwin/ &&
            cp bin/linux/ddev /tmp/bin/linux/ &&
            cp bin/windows/windows_amd64/ddev.exe /tmp/bin/windows

      - run:
          command: |
            sudo mkdir $ARTIFACTS && sudo chmod 777 $ARTIFACTS &&
            export VERSION=$(git describe --tags --always --dirty) &&
            tar -czf $ARTIFACTS/ddev_osx.$VERSION.tar.gz bin/darwin/darwin_amd64/ddev &&
            zip $ARTIFACTS/ddev_osx.$VERSION.zip bin/darwin/darwin_amd64/ddev &&
            tar -czf $ARTIFACTS/ddev_linux.$VERSION.tar.gz bin/linux/ddev &&
            zip $ARTIFACTS/ddev_linux.$VERSION.zip bin/linux/ddev &&
            tar -czf $ARTIFACTS/ddev_windows.$VERSION.tar.gz bin/windows/windows_amd64/ddev.exe &&
            zip $ARTIFACTS/ddev_windows.$VERSION.zip bin/windows/windows_amd64/ddev.exe
            cd $ARTIFACTS &&
            for item in *.tar.gz *.zip; do
              sha256sum $item > $item.sha256.txt
            done
          name: tar/zip up artifacts

      - store_artifacts:
          path: /artifacts
          name: Artifact storage

  junk_build:
    machine: true
    working_directory: ~/go/src/github.com/drud/ddev
    environment:
      DRUD_DEBUG: "true"
      GOPATH: /home/circleci/go
      ARTIFACTS: /artifacts
    steps:
      - run:
        command: |
          echo "Does it work as is?"
          echo "Do we need to do the && thing?"
          echo " I don't think so"
          make -s linux
        name: JUNK BUILD
