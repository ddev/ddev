version: 2
stages:
  build:
    macos:
      xcode: "9.0"

    environment:
      ARTIFACTS: /artifacts
      GOPATH: /Users/distiller/go

    working_directory: ~/go/src/github.com/drud/ddev

    steps:
      - run: mkdir -p ~/go/{lib,pkg,src/github.com/drud/ddev}
      - checkout

      - run: |
          brew cask install docker && brew install docker docker-compose golang

      - run:
          command: /Applications/Docker.app/Contents/MacOS/Docker --unattended >/tmp/docker.log 2>&1
          background: true

      - run: |
          sleep 5
          while ! sudo docker ps 2>/dev/null; do sleep 1; done
          sudo chmod ugo+rwx /var/root/library /var/root/Library/Containers /usr/local/bin/docker* /var/root /var/root/Library /var/root/Library/Group\ Containers/ /var/root/Library/Group\ Containers/group.com.docker/
          sudo chown distiller /var/run/docker.sock

      - run: docker run busybox ls
      - run: make test
