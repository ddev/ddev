name: MacOS tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  BUILDKIT_PROGRESS: plain
  DOCKER_CLI_EXPERIMENTAL: enabled

jobs:

  container-tests:
    name: Container tests
    runs-on: macos-latest

    steps:
      - name: Install Docker
        run: |
          mkdir ~/.docker
          brew install make docker docker-machine
          mkdir ~/.docker/cli-plugins
          curl -sSL https://github.com/docker/buildx/releases/download/v0.4.2/buildx-v0.4.2.darwin-amd64 -o ~/.docker/cli-plugins/docker-buildx
          chmod a+x ~/.docker/cli-plugins/docker-buildx
          docker buildx version
          docker-machine create --driver virtualbox default
          docker-machine env default

      - uses: actions/checkout@v2

      - name: Run container tests
        run: |
          eval "$(docker-machine env default)"
          docker version
          set -eu -o pipefail
          for dir in containers/*/
              do pushd $dir
              echo "--- Build container $dir"
              time make container DOCKER_ARGS=--no-cache
              echo "--- Test container $dir"
              time make test
              popd
          done
          set +eu

  ddev-tests:
    name: DDEV tests
    runs-on: macos-latest

    steps:
      - name: Install Docker
        run: |
          mkdir ~/.docker
          brew install make docker docker-machine
          mkdir ~/.docker/cli-plugins
          curl -sSL https://github.com/docker/buildx/releases/download/v0.4.2/buildx-v0.4.2.darwin-amd64 -o ~/.docker/cli-plugins/docker-buildx
          chmod a+x ~/.docker/cli-plugins/docker-buildx
          docker buildx version
          docker-machine create --driver virtualbox default
          docker-machine env default

      - uses: actions/checkout@v2

      - name: Run DDEV tests
        run: |
          eval "$(docker-machine env default)"
          docker version
          echo "Running tests..."
          time make test
          RV=$?
          echo "build.sh completed with status=$RV"
          ddev poweroff || true
          exit $RV
